---
import BaseLayout from "../layouts/BaseLayout.astro";
import CodeBlock from "../components/CodeBlock.astro";

const gatewayConfig = [
  { name: "Gateway__ApiKey", required: true, default: "-", desc: "Pre-shared key for Agent authentication. Must be at least 32 characters. Use a strong, randomly generated value." },
  { name: "Gateway__CaddyAdminUrl", required: false, default: "http://localhost:2019", desc: "URL to the Caddy Admin API. Used to dynamically configure routes." },
  { name: "Gateway__Port", required: false, default: "17200", desc: "Port the Gateway listens on for WebSocket connections from Agents." },
  { name: "Gateway__AllowedOrigins", required: false, default: "*", desc: "Comma-separated list of allowed CORS origins. Set to specific domains in production." },
];

const agentConfig = [
  { name: "Agent__GatewayFqdn", required: false, default: "-", desc: "Gateway domain (e.g., gateway.example.com). Recommended over GatewayUrl. Automatically derives the WebSocket URL and sends FQDN to Gateway for landing page routing." },
  { name: "Agent__GatewayUrl", required: false, default: "Derived from GatewayFqdn", desc: "WebSocket URL to the Gateway. If not set, derived from GatewayFqdn as wss://{GatewayFqdn}/tunnel." },
  { name: "Agent__ApiKey", required: true, default: "-", desc: "Pre-shared key matching the Gateway's ApiKey. Must be identical on both sides." },
  { name: "Agent__JwtSecret", required: true, default: "-", desc: "Secret key for signing JWT tokens. Must be at least 32 characters." },
  { name: "Agent__Auth__Username", required: true, default: "-", desc: "Username for the web management UI." },
  { name: "Agent__Auth__Password", required: true, default: "-", desc: "Password for the web management UI. Use a strong password." },
  { name: "Agent__Port", required: false, default: "17201", desc: "Port the Agent web UI listens on." },
  { name: "ConnectionStrings__DefaultConnection", required: false, default: "SQLite", desc: "Database connection string. Defaults to SQLite file storage." },
  { name: "Agent__HeartbeatIntervalSeconds", required: false, default: "30", desc: "Interval between heartbeat messages to keep the tunnel alive." },
  { name: "Agent__ReconnectDelaySeconds", required: false, default: "5", desc: "Initial delay before attempting reconnection after disconnect." },
  { name: "Agent__MaxReconnectDelaySeconds", required: false, default: "300", desc: "Maximum delay between reconnection attempts (exponential backoff cap)." },
];

const portAssignments = [
  { port: "17200", service: "Gateway", desc: "WebSocket endpoint for Agent connections" },
  { port: "17201", service: "Agent Web UI", desc: "Management interface for port mappings" },
  { port: "17202", service: "Caddy Admin", desc: "Caddy Admin API (internal)" },
  { port: "17280", service: "Caddy HTTP", desc: "HTTP ingress (redirects to HTTPS)" },
  { port: "17243", service: "Caddy HTTPS", desc: "HTTPS ingress for tunneled services" },
];

const envExample = `# Gateway Configuration
GATEWAY_API_KEY=your-secure-api-key-at-least-32-characters-long

# Agent Configuration
AGENT_GATEWAY_FQDN=gateway.yourdomain.com
AGENT_API_KEY=your-secure-api-key-at-least-32-characters-long
AGENT_JWT_SECRET=your-jwt-secret-at-least-32-characters-long
AGENT_USERNAME=admin
AGENT_PASSWORD=your-secure-admin-password

# Optional: Custom database path
# CONNECTION_STRING=Data Source=/custom/path/octoporty.db`;

const caddyfileExample = `{
    admin :2019
}

# Gateway WebSocket endpoint
gateway.yourdomain.com {
    reverse_proxy gateway:17200
}

# Tunneled services (managed dynamically by Gateway)
*.tunnel.yourdomain.com {
    reverse_proxy gateway:17200
}`;

const customDbPath = `# Custom SQLite database path
ConnectionStrings__DefaultConnection=Data Source=/custom/path/octoporty.db`;
---

<BaseLayout
  title="Configuration - Octoporty"
  description="Complete configuration reference for Octoporty Gateway and Agent."
>
  <section id="top" class="mb-8 md:mb-12">
    <h1 class="mb-2 text-2xl font-bold text-zinc-900 sm:text-3xl dark:text-white">Configuration</h1>
    <p class="text-zinc-600 dark:text-zinc-400">
      Complete reference for all Octoporty configuration options.
    </p>
  </section>

  <nav class="mb-8 rounded-xl border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800/50">
    <h2 class="mb-2 text-sm font-semibold tracking-wider text-zinc-400 uppercase">On this page</h2>
    <ul class="space-y-1 text-sm">
      <li><a href="#gateway" class="text-blue-600 hover:underline dark:text-blue-400">Gateway Configuration</a></li>
      <li><a href="#agent" class="text-blue-600 hover:underline dark:text-blue-400">Agent Configuration</a></li>
      <li><a href="#ports" class="text-blue-600 hover:underline dark:text-blue-400">Port Assignments</a></li>
      <li><a href="#env-file" class="text-blue-600 hover:underline dark:text-blue-400">Environment File Example</a></li>
      <li><a href="#caddy" class="text-blue-600 hover:underline dark:text-blue-400">Caddy Configuration</a></li>
      <li><a href="#database" class="text-blue-600 hover:underline dark:text-blue-400">Database Configuration</a></li>
      <li><a href="#security" class="text-blue-600 hover:underline dark:text-blue-400">Security Best Practices</a></li>
    </ul>
  </nav>

  <section id="gateway" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Gateway Configuration</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Environment variables for the Gateway service deployed on your cloud server.
    </p>

    <div class="overflow-x-auto">
      <table class="w-full min-w-[600px] text-sm">
        <thead>
          <tr class="border-b border-zinc-200 dark:border-zinc-700">
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Variable</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Required</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Default</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Description</th>
          </tr>
        </thead>
        <tbody>
          {
            gatewayConfig.map((item) => (
              <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
                <td class="px-3 py-3">
                  <code class="rounded bg-zinc-100 px-1.5 py-0.5 text-blue-600 dark:bg-zinc-800 dark:text-blue-400">
                    {item.name}
                  </code>
                </td>
                <td class="px-3 py-3">
                  {item.required ? (
                    <span class="rounded bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">Yes</span>
                  ) : (
                    <span class="rounded bg-zinc-100 px-2 py-0.5 text-xs font-medium text-zinc-500 dark:bg-zinc-800 dark:text-zinc-400">No</span>
                  )}
                </td>
                <td class="px-3 py-3 text-zinc-500 dark:text-zinc-400">
                  <code class="text-xs">{item.default}</code>
                </td>
                <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">{item.desc}</td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </section>

  <section id="agent" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Agent Configuration</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Environment variables for the Agent service deployed in your private network.
    </p>

    <div class="overflow-x-auto">
      <table class="w-full min-w-[600px] text-sm">
        <thead>
          <tr class="border-b border-zinc-200 dark:border-zinc-700">
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Variable</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Required</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Default</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Description</th>
          </tr>
        </thead>
        <tbody>
          {
            agentConfig.map((item) => (
              <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
                <td class="px-3 py-3">
                  <code class="rounded bg-zinc-100 px-1.5 py-0.5 text-blue-600 dark:bg-zinc-800 dark:text-blue-400">
                    {item.name}
                  </code>
                </td>
                <td class="px-3 py-3">
                  {item.required ? (
                    <span class="rounded bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">Yes</span>
                  ) : (
                    <span class="rounded bg-zinc-100 px-2 py-0.5 text-xs font-medium text-zinc-500 dark:bg-zinc-800 dark:text-zinc-400">No</span>
                  )}
                </td>
                <td class="px-3 py-3 text-zinc-500 dark:text-zinc-400">
                  <code class="text-xs">{item.default}</code>
                </td>
                <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">{item.desc}</td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </section>

  <section id="ports" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Port Assignments</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Octoporty uses the 17200-17299 port range by default. All ports are configurable.
    </p>

    <div class="overflow-x-auto">
      <table class="w-full min-w-[400px] text-sm">
        <thead>
          <tr class="border-b border-zinc-200 dark:border-zinc-700">
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Port</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Service</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Description</th>
          </tr>
        </thead>
        <tbody>
          {
            portAssignments.map((item) => (
              <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
                <td class="px-3 py-3">
                  <code class="rounded bg-zinc-100 px-1.5 py-0.5 text-blue-600 dark:bg-zinc-800 dark:text-blue-400">
                    {item.port}
                  </code>
                </td>
                <td class="px-3 py-3 font-medium text-zinc-900 dark:text-white">{item.service}</td>
                <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">{item.desc}</td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </section>

  <section id="env-file" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Environment File Example</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Complete .env file template with all configuration options.
    </p>

    <CodeBlock code={envExample} lang="bash" filename=".env" />
  </section>

  <section id="caddy" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Caddy Configuration</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Example Caddyfile for the Gateway server. Caddy automatically provisions TLS certificates.
    </p>

    <CodeBlock code={caddyfileExample} lang="bash" filename="Caddyfile" />

    <div class="mt-4 rounded-lg border border-amber-200 bg-amber-50 p-4 dark:border-amber-900/50 dark:bg-amber-900/20">
      <p class="text-sm text-amber-800 dark:text-amber-200">
        <strong>Note:</strong> The Gateway automatically manages Caddy routes via the Admin API when you create port mappings in the web UI. The wildcard domain configuration above is for initial setup.
      </p>
    </div>
  </section>

  <section id="database" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Database Configuration</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      The Agent uses SQLite for lightweight local storage. No external database is required.
    </p>

    <h3 class="mb-2 text-lg font-semibold text-zinc-800 dark:text-zinc-200">Default Location</h3>
    <p class="mb-4 text-sm text-zinc-600 dark:text-zinc-400">
      No configuration needed. Data is stored in <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">/app/data/octoporty.db</code> inside the container. Mount a volume to <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">/app/data</code> to persist data across container restarts.
    </p>

    <h3 class="mb-2 text-lg font-semibold text-zinc-800 dark:text-zinc-200">Container Permissions</h3>
    <p class="mb-4 text-sm text-zinc-600 dark:text-zinc-400">
      The <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">/app/data</code> directory is created at runtime and inherits the container's UID. Ensure the container runs as a user with write access to the mounted volume:
    </p>
    <ul class="mb-4 list-disc list-inside text-sm text-zinc-600 dark:text-zinc-400 space-y-1">
      <li><strong>Docker Compose:</strong> Add <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">user: "1000:1000"</code> to match your host user, or run <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">sudo chown -R 1000:1000 /path/to/data</code></li>
      <li><strong>TrueNAS SCALE:</strong> Set Security Context User ID to <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">568</code> (the apps user) and ensure your dataset is owned by apps (568:568)</li>
      <li><strong>Other NAS platforms:</strong> Run the container as a user with write access to the data directory</li>
    </ul>

    <h3 class="mb-2 text-lg font-semibold text-zinc-800 dark:text-zinc-200">Custom Path</h3>
    <CodeBlock code={customDbPath} lang="bash" filename=".env" />
  </section>

  <section id="security" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Security Best Practices</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Follow these guidelines to secure your Octoporty deployment.
    </p>

    <div class="space-y-4">
      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800/50">
        <h3 class="mb-1 font-semibold text-zinc-900 dark:text-white">Use Strong API Keys</h3>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Generate API keys with at least 32 characters using a cryptographically secure random generator:
          <code class="mt-1 block rounded bg-zinc-100 p-2 text-xs dark:bg-zinc-800">openssl rand -base64 32</code>
        </p>
      </div>

      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800/50">
        <h3 class="mb-1 font-semibold text-zinc-900 dark:text-white">Always Use HTTPS</h3>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Configure the Gateway URL with <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">wss://</code> (WebSocket Secure) in production. Never use unencrypted <code class="rounded bg-zinc-100 px-1 dark:bg-zinc-800">ws://</code> connections over the internet.
        </p>
      </div>

      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800/50">
        <h3 class="mb-1 font-semibold text-zinc-900 dark:text-white">Restrict Agent Access</h3>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          The Agent web UI should only be accessible from your internal network. Do not expose port 17201 to the public internet.
        </p>
      </div>

      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800/50">
        <h3 class="mb-1 font-semibold text-zinc-900 dark:text-white">Rotate Credentials</h3>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Periodically rotate API keys and passwords. Update both Gateway and Agent simultaneously to avoid connection issues.
        </p>
      </div>

      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800/50">
        <h3 class="mb-1 font-semibold text-zinc-900 dark:text-white">Monitor Logs</h3>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Review request logs regularly for suspicious activity. The Agent web UI provides an audit trail of all tunneled requests.
        </p>
      </div>
    </div>
  </section>
</BaseLayout>
