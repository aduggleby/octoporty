# Caddyfile
# Caddy configuration for Octoporty Gateway.
# In test mode, routes directly to Gateway without HTTPS.
# Dynamic routes are added via Caddy Admin API by Gateway.

{
    # Enable admin API for Gateway to manage routes
    admin 0.0.0.0:2019

    # For testing without ACME - disable auto HTTPS
    # Remove this block in production to enable automatic HTTPS
    auto_https off
}

# Health check endpoint on port 80
:80 {
    respond /health "OK" 200

    # Fallback - proxy everything to Gateway
    # Gateway's RequestRoutingMiddleware will handle routing by Host header
    reverse_proxy gateway:17200 {
        # WebSocket support for tunnel connections
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Note: Dynamic routes for tunneled services are added via the Admin API
# Example route added by Gateway:
#
# :443 {
#     @myapp host myapp.example.com
#     handle @myapp {
#         reverse_proxy gateway:17200 {
#             header_up X-Octoporty-Mapping-Id "uuid-here"
#         }
#     }
# }
